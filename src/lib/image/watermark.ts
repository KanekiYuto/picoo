import sharp from 'sharp';

/**
 * FluxReve Logo SVG 路径（使用矢量路径，不依赖字体）
 */
const LOGO_SVG_PATHS = `
<g stroke-linecap="round" fill-rule="nonzero" stroke="none">
  <path d="M 10.3 34.5 L 9.65 35.95 A 32.591 32.591 0 0 1 4.897 34.034 A 12.632 12.632 0 0 1 4.65 33.9 A 3.181 3.181 0 0 1 2.957 32.426 A 0.453 0.453 0 0 1 2.95 32.35 Q 2.95 31.8 3.05 31.2 Q 3.15 30.6 3.25 29.45 Q 3.35 28.3 3.35 26.15 L 3.35 16.8 Q 3.35 13.5 3.625 11.425 Q 3.9 9.35 4.2 8.2 L 2.5 8.2 L 0 4.85 L 0.4 4.05 L 16.3 4.05 L 18.75 7.55 L 16.2 9.8 L 15.2 9.8 Q 14.7 9.05 13.975 8.625 Q 13.25 8.2 12.1 8.2 L 9.4 8.2 Q 9.05 9.55 8.725 11.6 Q 8.4 13.65 8.4 16.45 L 8.4 17.75 L 15.35 17.75 L 17.5 21.2 L 17.15 22.05 L 8.4 22.05 L 8.4 27.25 Q 8.4 29.4 8.275 30.675 Q 8.15 31.95 8.15 32.65 A 2.443 2.443 0 0 0 9.796 34.252 A 12.39 12.39 0 0 0 10.3 34.5 Z" />
  <path d="M 28.7 34.75 L 28.1 36.1 A 38.501 38.501 0 0 1 23.396 34.048 A 15.818 15.818 0 0 1 23.175 33.925 Q 21.45 32.95 21.45 32.15 Q 21.45 31.45 21.625 29.975 Q 21.8 28.5 21.8 27.1 L 21.8 13.65 Q 21.8 10.65 22.025 8.125 Q 22.25 5.6 22.6 4.05 L 20.45 4.05 L 17.7 0.8 L 18.05 0 L 24.55 0 L 27.5 3.8 Q 27.15 5.75 26.95 8.225 Q 26.75 10.7 26.75 13.25 L 26.75 27.65 Q 26.75 29.45 26.6 30.825 Q 26.45 32.2 26.45 32.9 Q 26.45 33.4 26.825 33.675 Q 27.2 33.95 28.7 34.75 Z" />
  <path d="M 51.55 34.55 L 50.9 35.85 Q 49.75 35.4 48.8 34.9 Q 47.85 34.4 47 33.8 Q 45.95 34.65 44.5 35.2 Q 43.05 35.75 41.8 35.75 Q 40.9 35.75 39.35 35.15 Q 37.8 34.55 36.2 33.55 Q 34.6 32.55 33.5 31.375 Q 32.4 30.2 32.4 29.1 Q 32.4 28.35 32.525 26.675 Q 32.65 25 32.65 22.85 L 32.65 19.95 Q 32.65 18.65 32.775 17.525 Q 32.9 16.4 33.2 15.55 L 31.55 15.55 L 28.9 12.15 L 29.25 11.3 L 35.65 11.3 L 38.55 15.2 Q 37.95 16 37.775 17.2 Q 37.6 18.4 37.6 20.25 L 37.6 23.2 A 143.783 143.783 0 0 1 37.558 27.138 A 41.393 41.393 0 0 1 37.525 28 Q 37.45 29.5 37.45 30.1 Q 37.45 31.5 39.15 31.5 Q 40.4 31.5 41.575 31.025 Q 42.75 30.55 43.525 29.625 Q 44.3 28.7 44.3 27.4 L 44.3 19.95 Q 44.3 18.65 44.425 17.525 Q 44.55 16.4 44.85 15.55 L 43.2 15.55 L 40.55 12.15 L 40.9 11.3 L 47.3 11.3 L 50.2 15.2 Q 49.6 16 49.425 17.2 Q 49.25 18.4 49.25 20.25 L 49.25 25.6 A 63.855 63.855 0 0 1 49.152 29.728 A 19.842 19.842 0 0 1 49.15 29.75 Q 49.05 31.15 49.05 31.8 Q 49.05 32.6 49.625 33.225 Q 50.2 33.85 51.55 34.55 Z" />
  <path d="M 59.8 34.85 L 59.2 36.3 A 28.878 28.878 0 0 1 54.868 34.43 A 9.662 9.662 0 0 1 54.525 34.225 Q 53.05 33.3 53.05 32.75 A 5.452 5.452 0 0 1 53.942 30.846 A 27.066 27.066 0 0 1 54 30.75 Q 54.95 29.2 56.475 27.125 Q 58 25.05 59.75 23 Q 57.3 21.3 56.1 19.675 Q 54.9 18.05 54.9 16.35 Q 54.9 16 55 15.55 L 54.15 15.55 L 51.85 12.1 L 52.2 11.3 L 58.25 11.3 L 60.6 14.9 L 60.6 15.55 Q 59.35 16.25 59.35 18 Q 59.35 20 61 21.55 Q 62.6 19.75 63.9 18.3 Q 65.2 16.85 66.55 15.55 L 65.35 15.55 L 62.9 12.1 L 63.25 11.3 L 68.95 11.3 L 71.85 15.35 Q 70.45 17.2 68.875 19.375 Q 67.3 21.55 64.8 24.3 Q 67.4 26.25 68.95 28.325 Q 70.5 30.4 70.5 33.1 L 70.5 33.55 Q 70.5 33.8 70.45 34.1 L 72.3 35 L 71.75 36.45 A 195.87 195.87 0 0 1 67.394 34.771 A 62.46 62.46 0 0 1 66.975 34.6 A 3.019 3.019 0 0 1 65.405 33.642 A 0.172 0.172 0 0 1 65.4 33.6 L 65.4 32.55 Q 65.4 30.7 65 28.9 Q 64.6 27.1 63.55 25.75 Q 62.1 27.45 60.85 29.125 Q 59.6 30.8 58.825 32.025 Q 58.05 33.25 58.05 33.6 Q 58.05 33.95 58.375 34.15 Q 58.7 34.35 59.8 34.85 Z" />
  <path d="M 83.4 34.65 L 82.75 36.1 A 32.591 32.591 0 0 1 77.997 34.184 A 12.632 12.632 0 0 1 77.75 34.05 A 3.181 3.181 0 0 1 76.057 32.576 A 0.453 0.453 0 0 1 76.05 32.5 Q 76.05 31.95 76.15 31.35 Q 76.25 30.75 76.35 29.6 Q 76.45 28.45 76.45 26.3 L 76.45 16.8 Q 76.45 13.5 76.725 11.425 Q 77 9.35 77.3 8.2 L 75.6 8.2 L 73.1 4.85 L 73.5 4.05 L 78.2 4.05 Q 79.75 4 81.325 3.925 Q 82.9 3.85 83.8 3.85 Q 85.15 3.85 86.775 4.65 Q 88.4 5.45 89.875 6.7 Q 91.35 7.95 92.3 9.275 Q 93.25 10.6 93.25 11.6 L 93.25 16.05 Q 93.25 20.35 89.5 22.2 A 8.63 8.63 0 0 1 93.045 25.215 A 3.036 3.036 0 0 1 93.45 26.7 Q 93.45 27.8 93.4 29.4 Q 93.35 31 93.35 32.15 Q 93.35 32.95 93.9 33.475 Q 94.45 34 95.75 34.7 L 95 36.2 Q 91.65 34.75 89.85 33.7 Q 88.05 32.65 88.05 31.4 Q 88.05 30.15 88.15 28.725 Q 88.25 27.3 88.25 26.35 Q 88.25 24.65 86.85 23.725 A 8.045 8.045 0 0 0 82.589 22.801 A 19.611 19.611 0 0 0 82.4 22.8 L 81.5 22.8 L 81.5 27.4 Q 81.5 29.55 81.375 30.825 Q 81.25 32.1 81.25 32.8 A 2.443 2.443 0 0 0 82.896 34.402 A 12.39 12.39 0 0 0 83.4 34.65 Z M 81.5 16.45 L 81.5 18.6 L 84.6 18.6 Q 86.35 18.6 87.325 17.375 Q 88.3 16.15 88.3 13.85 L 88.3 11.1 Q 88.3 9.5 87.85 8.85 Q 87.4 8.2 86.3 8.2 Q 85.35 8.2 84.375 8.275 Q 83.4 8.35 82.4 8.5 Q 82.05 9.85 81.775 11.825 Q 81.5 13.8 81.5 16.45 Z" />
  <path d="M 113.2 17.8 L 113.2 21.9 Q 113.2 25.95 108.7 25.95 Q 107.3 25.95 105.5 25.775 Q 103.7 25.6 102.3 25.35 Q 102.25 27 102.225 28.325 Q 102.2 29.65 102.2 29.85 Q 102.2 30.65 102.6 31 Q 103 31.35 104.05 31.35 Q 105.6 31.35 107.425 30.875 Q 109.25 30.4 110.7 29.45 L 111.45 29.45 L 114.15 33.55 Q 113.2 34.45 111.325 35.05 Q 109.45 35.65 107.7 35.65 Q 106.5 35.65 104.75 35.025 Q 103 34.4 101.275 33.375 Q 99.55 32.35 98.4 31.125 Q 97.25 29.9 97.25 28.7 A 59.121 59.121 0 0 1 97.348 25.916 A 194.639 194.639 0 0 1 97.425 24.55 Q 97.6 21.6 97.6 17.5 A 5.879 5.879 0 0 1 104.05 11.014 A 14.456 14.456 0 0 1 104.7 11 Q 105.8 11 107.25 11.675 Q 108.7 12.35 110.05 13.425 Q 111.4 14.5 112.3 15.65 Q 113.2 16.8 113.2 17.8 Z M 108.35 19.3 L 108.35 16.6 Q 108.35 16.05 108.05 15.65 Q 107.75 15.25 106.75 15.25 Q 104.75 15.25 103.6 16.075 Q 102.45 16.9 102.45 19.1 Q 102.45 19.5 102.425 20.3 Q 102.4 21.1 102.4 22.1 Q 103.85 22.25 105.75 22.25 Q 107.2 22.25 107.775 21.525 Q 108.35 20.8 108.35 19.3 Z" />
  <path d="M 116.9 15.55 L 115.75 15.55 L 113.3 12.1 L 113.7 11.3 L 120.05 11.3 L 122.35 14.65 L 122.35 15.3 Q 121.25 15.5 120.85 16.15 Q 120.45 16.8 120.45 17.8 Q 120.45 18.35 120.7 19.575 Q 120.95 20.8 121.65 23.425 Q 122.35 26.05 123.7 30.75 Q 124.4 28.95 125.1 27.075 Q 125.8 25.2 126.75 22.475 A 2321.454 2321.454 0 0 0 128.795 16.577 A 4233.824 4233.824 0 0 0 129.15 15.55 L 126.95 15.55 L 124.65 12.1 L 125 11.3 L 131.25 11.3 L 134.3 15.5 A 1250.059 1250.059 0 0 1 131.544 23.623 A 633.849 633.849 0 0 1 130.8 25.775 Q 129.4 29.8 128.55 32.05 A 32.845 32.845 0 0 1 127.255 35.142 A 7.38 7.38 0 0 1 127.225 35.2 Q 126.75 36.1 126.45 36.1 Q 125.9 36.1 124.875 35.375 Q 123.85 34.65 122.75 33.6 Q 121.65 32.55 120.825 31.625 Q 120 30.7 119.9 30.25 Q 118.8 25.8 118.1 23.125 Q 117.4 20.45 117.075 18.975 Q 116.75 17.5 116.75 16.7 Q 116.75 16.1 116.9 15.55 Z" />
  <path d="M 152.75 17.8 L 152.75 21.9 Q 152.75 25.95 148.25 25.95 Q 146.85 25.95 145.05 25.775 Q 143.25 25.6 141.85 25.35 Q 141.8 27 141.775 28.325 Q 141.75 29.65 141.75 29.85 Q 141.75 30.65 142.15 31 Q 142.55 31.35 143.6 31.35 Q 145.15 31.35 146.975 30.875 Q 148.8 30.4 150.25 29.45 L 151 29.45 L 153.7 33.55 Q 152.75 34.45 150.875 35.05 Q 149 35.65 147.25 35.65 Q 146.05 35.65 144.3 35.025 Q 142.55 34.4 140.825 33.375 Q 139.1 32.35 137.95 31.125 Q 136.8 29.9 136.8 28.7 A 59.121 59.121 0 0 1 136.898 25.916 A 194.639 194.639 0 0 1 136.975 24.55 Q 137.15 21.6 137.15 17.5 A 5.879 5.879 0 0 1 143.6 11.014 A 14.456 14.456 0 0 1 144.25 11 Q 145.35 11 146.8 11.675 Q 148.25 12.35 149.6 13.425 Q 150.95 14.5 151.85 15.65 Q 152.75 16.8 152.75 17.8 Z M 147.9 19.3 L 147.9 16.6 Q 147.9 16.05 147.6 15.65 Q 147.3 15.25 146.3 15.25 Q 144.3 15.25 143.15 16.075 Q 142 16.9 142 19.1 Q 142 19.5 141.975 20.3 Q 141.95 21.1 141.95 22.1 Q 143.4 22.25 145.3 22.25 Q 146.75 22.25 147.325 21.525 Q 147.9 20.8 147.9 19.3 Z" />
</g>
`;

/**
 * 创建水印 SVG（在多个位置添加水印，防止被裁剪去除）
 */
function createWatermarkSVG(width: number, height: number): string {
  // 原始 Logo 尺寸
  const logoWidth = 153.7;
  const logoHeight = 36.45;

  // 计算水印大小（取图片宽度的 1/5，至少200px）
  const watermarkWidth = Math.max(width / 5, 200);
  const watermarkHeight = (watermarkWidth / logoWidth) * logoHeight;
  const scale = watermarkWidth / logoWidth;

  // 计算边距
  const padding = Math.floor(width / 40);

  // 定义水印位置：右上角、中央、右下角
  const positions = [
    // 右上角 - 主水印
    {
      x: width - watermarkWidth - padding,
      y: padding,
      opacity: 0.8,
    },
    // 中央 - 防止裁剪
    {
      x: (width - watermarkWidth) / 2,
      y: (height - watermarkHeight) / 2,
      opacity: 0.15,
    },
    // 右下角 - 辅助水印
    {
      x: width - watermarkWidth - padding,
      y: height - watermarkHeight - padding,
      opacity: 0.5,
    },
  ];

  // 生成多个水印
  const watermarks = positions
    .map(
      (pos) => `
    <g transform="translate(${pos.x}, ${pos.y}) scale(${scale})" opacity="${pos.opacity}" fill="white">
      ${LOGO_SVG_PATHS}
    </g>
  `
    )
    .join('');

  return `
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
  ${watermarks}
</svg>
  `.trim();
}

/**
 * 为图片添加水印
 * 在图片右上角添加 FluxReve Logo 水印
 */
export async function addWatermark(imageBuffer: Buffer): Promise<Buffer> {
  try {
    const image = sharp(imageBuffer);
    const metadata = await image.metadata();

    if (!metadata.width || !metadata.height) {
      // 如果无法获取图片尺寸，返回原图
      return imageBuffer;
    }

    const { width, height } = metadata;

    // 创建水印 SVG
    const svgWatermark = createWatermarkSVG(width, height);

    // 将水印合成到图片上
    const watermarkedImage = await image
      .composite([
        {
          input: Buffer.from(svgWatermark),
          top: 0,
          left: 0,
        },
      ])
      .toBuffer();

    return watermarkedImage;
  } catch (error) {
    console.error('Failed to add watermark:', error);
    // 如果添加水印失败，返回原图
    return imageBuffer;
  }
}
